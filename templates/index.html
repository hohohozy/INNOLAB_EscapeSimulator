<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Fire Evacuation Simulation</title>
    <style>
        body { font-family: sans-serif; }
        #map { display: grid; grid-template-columns: repeat(9, 30px); grid-gap: 2px; margin-top: 10px; }
        .cell { width: 30px; height: 30px; text-align: center; font-size: 14px; line-height: 30px; }
        .empty { background: #eee; }
        .fire { background: red; color: white; }
        .evacuee { background: blue; color: white; font-weight: bold; }
        .person { background: green; color: white; }
        .trapped { background: gray; color: white; }
        .stairs { background: yellow; }
        .exit { background: orange; }
        .wall { background: black; }
        .medical { background: lightblue; }
        .extinguisher { background: purple; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ”¥ Fire Evacuation Simulator</h1>
    <button onclick="toggleAuto()">â¯ è‡ªåŠ¨æ¨¡æ‹Ÿ</button>
    <button onclick="nextStep()">â­ æ‰‹åŠ¨ä¸€æ­¥</button>

    <div id="status">
        <p>è½®æ•°ï¼š<span id="turn">0</span></p>
        <p>é€ƒå‡ºäººæ•°ï¼š<span id="escaped">0</span></p>
        <p>è¢«å›°äººæ•°ï¼š<span id="trapped">0</span></p>
        <p>ä»åœ¨é€ƒç”Ÿï¼š<span id="alive">0</span></p>
    </div>

    <div id="map"></div>

    <script>
        let auto = false;
        let turn = 0;
        let intervalId = null;

        function toggleAuto() {
            auto = !auto;
            if (auto) {
                intervalId = setInterval(nextStep, 1000);
            } else {
                clearInterval(intervalId);
            }
        }

        async function nextStep() {
            const res = await fetch('/next');
            const data = await res.json();
            turn = data.turn;
            updateStats(data);
            renderMap(data);
        }

        function updateStats(data) {
            const total = data.people.length;
            const escaped = data.people.filter(p => p.status === 'escaped').length;
            const trapped = data.people.filter(p => p.status === 'trapped').length;
            const alive = total - escaped - trapped;

            document.getElementById('turn').innerText = turn;
            document.getElementById('escaped').innerText = escaped;
            document.getElementById('trapped').innerText = trapped;
            document.getElementById('alive').innerText = alive;
        }

        function renderMap(data) {
            const map = document.getElementById('map');
            map.innerHTML = '';
            const floors = 2;
            for (let f = 0; f < floors; f++) {
                const label = document.createElement('div');
                label.innerHTML = `<b>Floor ${f}</b>`;
                label.style.gridColumn = 'span 9';
                map.appendChild(label);

                for (let y = 0; y < 9; y++) {
                    for (let x = 0; x < 9; x++) {
                        const cell = document.createElement('div');
                        cell.classList.add('cell', 'empty');
                        const pos = [x, y, f];

                        if (data.fire.some(p => same(p, pos))) cell.classList.add('fire');
                        else if (data.people.some(p => same(p.pos, pos) && p.status === 'alive')) cell.classList.add('person');
                        else if (data.people.some(p => same(p.pos, pos) && p.status === 'trapped')) {
                            cell.classList.add('trapped');
                            cell.innerText = 'X';
                        }
                        else if (data.path && data.path.length > 0 && same(data.path[0], pos)) cell.classList.add('evacuee');
                        if (stairs.some(p => p[0] === x && p[1] === y)) cell.classList.add('stairs');
                        if (exits.some(p => same(p, pos))) cell.classList.add('exit');
                        if (walls.some(p => p[0] === x && p[1] === y)) cell.classList.add('wall');
                        if (medical_points.some(p => same(p, pos))) cell.classList.add('medical');
                        if (extinguishers.some(p => same(p, pos))) cell.classList.add('extinguisher');

                        map.appendChild(cell);
                    }
                }
            }
        }

        function same(a, b) {
            return a[0] === b[0] && a[1] === b[1] && a[2] === b[2];
        }

        // æ¨¡æ‹Ÿæ•°æ®ï¼ˆé¦–æ¬¡åŠ è½½ä½¿ç”¨ï¼‰
        let stairs = [[4, 4]];
        let exits = [[0, 8, 0], [8, 8, 0]];
        let walls = [];
        let medical_points = [];
        let extinguishers = [];

        // è·å–åˆå§‹åŒ–åœ°å›¾æ•°æ®ï¼ˆå¦‚å¢™ä½“ã€åŒ»ç–—ç­‰ï¼‰
        fetch('/').then(res => res.text()).then(html => {
            document.open();
            document.write(html);
            document.close();
        });

        nextStep(); // åˆå§‹åŒ–ä¸€æ­¥
    </script>
</body>
</html>
